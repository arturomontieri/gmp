#!/bin/bash

prjfolder=/usr/local/gmp/
source ${prjfolder}/bin/gmp-env
myself=$(basename $0)
mlog=${prjfolder}/$logfolder/$myself.log
mpid=${prjfolder}/$pidfolder/$myself.pid

app="finaliser"
tmp=${app}_fh
#With the following statement fh will get the value decalred in gmp-env file
#for the variable $tmp, i.e. libqueue_fh
fh=${!tmp}
tmp=${app}_timeout
timeout=${!tmp}

echo '------- Starting  at ' `date` >>$mlog

#Check if process is a zombie, i.e. dead but running for more than $timeout (ddhhmmss)

# Get all PIDs for process name
processes="finaliser\|$app\|$myself"
procs=`ps aux | grep  $processes | grep 'bash\|python' | awk '{print $2}'`

# for each PID in PIDs array
for pid in $procs; do
    echo "WARNING: Found process $pid already running"
    ps aux |grep $pid |grep -v grep |grep -v "ps aux"
    # get elapsed time in form mm:ss and remove ":" character
    # to make it easier to parse time 
    # $time is 'ELAPSED' for missing $pid
    time=`ps -o etime $pid | sed -e 's/[:-]//g'|tail -1`
    # if proces runs since more than $timeout kill it
    if [ "$time" -gt $timeout ]; then
        echo "WARNING Process $pid is running for more than $timeout; killing it" >>$mlog 2>>$mlog
        echo `ps -o etime $pid` >>$mlog 2>>$mlog
        kill $pid
    fi
done;


eval "exec $fh>$mpid"
eval "flock -x -w 1 -e $fh || exit 0" 

echo `date` " Calling  ${prjfolder}/bin/${app} " >> $mlog

alog=${prjfolder}/log/${app}.log
${prjfolder}/bin/${app} 1>>$alog 2>>$alog

echo `date` " Completed " >> $mlog

